# battle_online_spec.md — 対戦モード（CPU/オンライン）仕様（正本）

## 0. 目的 / 前提

- 対戦モードは以下の3構成で提供する。
  - CPU対戦（オフライン）
  - ルーム作成（オンライン）
  - ルーム入室（オンライン）
- UIのベースは一人用（ステージ）クイズ画面を流用し、対戦用HUDを追加して共通化する。
- オンライン対戦は **サーバーオーソリティ** を採用する。
  - 進行・判定・スコア・順位はサーバーが正
  - クライアントは「表示」と「入力送信」に責務を絞る

---

## 1. 対戦の共通ルール

### 1-1. 対戦人数
- 2〜4人

### 1-2. 問題数 / 制限時間
- 10問固定
- 1問あたり 20秒
- 進行条件（次の問題へ）
  - 全員が回答完了 もしくは
  - 20秒経過（未回答はタイムアウト扱い）

### 1-3. 回答と判定
- 正誤判定は「選択肢 index」により行う（question master の correct_index 等を参照）
- タイムアウトは「未回答」として扱い、正解扱いにはしない

### 1-4. 得点ルール
- 1問ごとに「正解した人のうち、回答が早い順」上位3名にポイント付与
  - 1位：3pt
  - 2位：2pt
  - 3位：1pt
  - 不正解：0pt
  - タイムアウト（未回答）：0pt

### 1-5. 勝敗と順位
- 10問終了時点の合計ptで順位を決定
- 同点の場合のタイブレーク（優先順）
  1) 正解数（多い方が上位）
  2) 正解時の合計回答時間（短い方が上位）
  3) それでも同率なら入室順（または playerIndex の小さい方）

### 1-6. 勝敗の定義（戦績記録用）
- 1位のみ「勝ち」
- 2位〜4位は「負け」

### 1-7. コイン報酬（案1）
- 1位：+30
- 2位：+20
- 3位：+10
- 4位：+0

---

## 2. CPU対戦（オフライン）

### 2-1. 構成
- 自分 + CPU3人の計4人対戦
- CPUの強さは事前設定（弱い / 普通 / 強い）
- CPUアバターはランダム（表示したものをその試合で固定使用）

### 2-2. CPUの強さパラメータ
- 正答率（弱い→普通→強い） = 50% / 75% / 100%
- 回答基準時間（弱い→普通→強い） = 8s / 6s / 4s
- 実際の回答時間は基準時間にランダム幅を持たせる（早い時も遅い時もある）

### 2-3. 問題選定
- マスタ全体（questions.json）からランダムで10問
- 既存ステージやテーマは問わない（重複禁止などは本仕様では定義しない）

---

## 3. オンライン対戦（ルーム方式）

### 3-1. ルーム方式
- ルームID入力型
- ルーム作成者＝ホスト
- 開始前のみ入室可
- ホストが開始ボタンを押した時点で入室を締め切る（開始後の途中参加不可）

### 3-2. ルーム開始条件
- 参加者が2人以上で開始可能
- ルールは固定（ホストが変更できる項目なし）

### 3-3. ルーム待機画面のプレイヤー表示
- 最大4枠を横並びで表示
- 入室したプレイヤーが順に表示される
- 表示内容（各プレイヤー枠）
  - プレイヤー名
  - アバター
  - 称号
  - 対人戦の勝敗数（後述の save 参照）

---

## 4. オンラインの正の所在（サーバーオーソリティ）

### 4-1. サーバーが正とする情報（必須）
- 問題ID（10問のリスト）
- 出題開始時刻（各問の開始タイミング）
- 各プレイヤーの回答時刻（ミリ秒）
- 正誤判定
- pt加算
- 最終順位 / 報酬

### 4-2. クライアントで完結してよい情報
- タイプライター演出（表示速度等）
- SE / BGM
- アニメーション・演出

---

## 5. 切断（オンライン）

### 5-1. 切断時の扱い
- 切断したプレイヤーは「その時点で敗北扱い」
- 残りのプレイヤーで試合は続行する

### 5-2. 切断者のスコア
- 切断時点までのスコアは保持してよい
- ただし最終結果では「敗北（最下位扱い）」として扱う

（※実装上の扱いは server のロジックで統一する）

---

## 6. スタンプ（オンライン ルーム内メッセージ）

- ルーム内で「よろしく！」等のメッセージスタンプを送信可能
- 本仕様ではスタンプの種類・UI詳細は定義しない（後続で確定）
- 実装時はスパム防止として送信頻度制限（例：1秒に1回など）を設ける

---

## 7. セーブ（戦績の保持）

### 7-1. 戦績の分離
- CPU戦の勝敗数と、対人戦の勝敗数は分けて管理する

### 7-2. 保存責務
- クライアントは SaveManager 経由で保存する
- サーバーは個人のセーブデータを保持しない（ルーム内の進行に必要な最低限のみ）

（※具体的な保存先/キー/データ構造は save_spec.md を正本とする）

---

## 8. 通信イベント（案：実装の足場）

※イベント名・payload の最終決定は実装と合わせて調整可。
ただし「サーバーが正」を崩さないこと。

### 8-1. ルーム系
- client -> server
  - room:create { playerProfile }
  - room:join { roomId, playerProfile }
  - room:leave { roomId }
  - room:start { roomId }
  - room:stamp { roomId, stampId }
- server -> client
  - room:state { roomId, players[], status }  // waiting/locked/playing/ended
  - room:error { code, message }

### 8-2. ゲーム進行
- server -> client
  - game:begin { roomId, questionIds[10], startedAt }
  - game:question { index, qid, questionStartAt, timeLimitSec:20 }
  - game:result_question { index, awarded[], points[], correctCounts[] }
  - game:result_final { standings[], coinRewardMap, winLoseMap }
- client -> server
  - game:answer { roomId, index, choiceIndex, clientAnsweredAt } 
    - サーバーは受信時刻も記録し、必要なら補正する

---

## 9. 実装上の注意

- スコア・順位・報酬はサーバー正（改ざん対策）
- 進行（次問へ遷移）はサーバーがトリガーする
  - 全員回答 or 20秒経過
- 仕様にない独断実装は禁止
